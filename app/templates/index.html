{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">

    <!-- Header -->
    <header class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold text-gray-800">
                <span class="text-3xl">üíç</span> Notre Mariage
            </h1>
        </div>
        <div class="flex items-center gap-3">
            <div id="countdown" class="bg-red-600 text-white px-5 py-2 rounded-full font-bold text-lg shadow">
                J-<span id="days-left">--</span>
            </div>
            <button onclick="openConfigModal()" class="p-2.5 bg-white rounded-full shadow hover:shadow-md transition-shadow border border-gray-200">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- Tabs Navigation -->
    <div class="flex gap-1 mb-6 bg-white p-1 rounded-lg shadow-sm border border-gray-200 inline-flex">
        <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn active flex items-center gap-2 px-5 py-2.5 rounded-md font-medium transition-all bg-red-600 text-white">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            Dashboard
        </button>
        <button onclick="switchTab('tasks')" id="tab-tasks" class="tab-btn flex items-center gap-2 px-5 py-2.5 rounded-md font-medium transition-all text-gray-600 hover:bg-gray-100">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
            </svg>
            T√¢ches
            <span id="tasks-badge" class="bg-red-100 text-red-600 px-2 py-0.5 rounded-full text-xs font-bold">0</span>
        </button>
    </div>

    <!-- ==================== TAB: DASHBOARD ==================== -->
    <div id="content-dashboard" class="tab-content">
        <!-- Budget Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <!-- Budget Fix√© -->
            <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100 card-hover">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-500 text-sm font-medium">Budget Fix√©</span>
                    <span class="text-xl">üí∞</span>
                </div>
                <div class="text-2xl font-bold text-gray-800" id="budget-fixe">0 Ar</div>
            </div>

            <!-- Budget D√©pens√© -->
            <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100 card-hover">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-500 text-sm font-medium">D√©pens√©</span>
                    <span class="text-xl">üí∏</span>
                </div>
                <div class="text-2xl font-bold" id="budget-depense">0 Ar</div>
                <div class="mt-2 bg-gray-100 rounded-full h-1.5">
                    <div id="budget-progress" class="bg-red-500 h-1.5 rounded-full progress-bar" style="width: 0%"></div>
                </div>
                <div class="text-xs text-gray-500 mt-1"><span id="pourcentage-depense">0</span>% du budget</div>
            </div>

            <!-- Budget Restant -->
            <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100 card-hover">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-500 text-sm font-medium">Restant</span>
                    <span class="text-xl">‚ú®</span>
                </div>
                <div class="text-2xl font-bold text-gray-800" id="budget-restant">0 Ar</div>
            </div>
        </div>

        <!-- Charts & Progress Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
            <!-- Camembert -->
            <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
                <h3 class="text-base font-semibold text-gray-800 mb-4">R√©partition des D√©penses</h3>
                <div class="relative" style="height: 260px;">
                    <canvas id="budget-chart"></canvas>
                </div>
            </div>

            <!-- Progression par Cat√©gorie -->
            <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
                <h3 class="text-base font-semibold text-gray-800 mb-4">Progression par Cat√©gorie</h3>
                <div id="category-progress" class="space-y-3">
                    <!-- Filled by JS -->
                </div>
            </div>
        </div>

        <!-- Top D√©pense & Avancement Global -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Top D√©pense -->
            <div class="bg-red-600 rounded-xl shadow-sm p-5 text-white">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xl">üèÜ</span>
                    <span class="font-medium text-red-100">Top D√©pense</span>
                </div>
                <div id="top-depense" class="text-xl font-bold">-</div>
                <div id="top-depense-details" class="text-sm text-red-200 mt-1">-</div>
            </div>

            <!-- Avancement Global -->
            <div class="bg-gray-800 rounded-xl shadow-sm p-5 text-white">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xl">üéØ</span>
                    <span class="font-medium text-gray-300">Avancement Global</span>
                </div>
                <div class="flex items-end gap-2">
                    <span id="avancement-global" class="text-3xl font-bold">0%</span>
                    <span id="taches-count" class="text-sm text-gray-400 mb-1">0/0 t√¢ches</span>
                </div>
                <div class="mt-3 bg-gray-700 rounded-full h-2">
                    <div id="avancement-progress" class="bg-red-500 h-2 rounded-full progress-bar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== TAB: T√ÇCHES ==================== -->
    <div id="content-tasks" class="tab-content hidden">
        <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-lg font-semibold text-gray-800">Gestion des T√¢ches</h3>
                <button onclick="openTaskModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Nouvelle t√¢che
                </button>
            </div>

            <!-- Stats rapides -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
                <div class="bg-gray-50 rounded-lg p-3 text-center border border-gray-100">
                    <div id="stat-terminees" class="text-xl font-bold text-gray-800">0</div>
                    <div class="text-xs text-gray-500">Termin√©es</div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3 text-center border border-gray-100">
                    <div id="stat-en-cours" class="text-xl font-bold text-red-600">0</div>
                    <div class="text-xs text-gray-500">En cours</div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3 text-center border border-gray-100">
                    <div id="stat-toky" class="text-xl font-bold text-gray-800">0</div>
                    <div class="text-xs text-gray-500">{{ config.nom_partenaire_1 }}</div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3 text-center border border-gray-100">
                    <div id="stat-hanja" class="text-xl font-bold text-gray-800">0</div>
                    <div class="text-xs text-gray-500">{{ config.nom_partenaire_2 }}</div>
                </div>
            </div>

            <!-- Filter by status -->
            <div class="flex gap-2 mb-4">
                <button onclick="filterByStatus('all')" class="status-filter-btn active px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-800 text-white" data-status="all">
                    Tous
                </button>
                <button onclick="filterByStatus('pending')" class="status-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200" data-status="pending">
                    ‚è≥ En cours
                </button>
                <button onclick="filterByStatus('done')" class="status-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200" data-status="done">
                    ‚úÖ Termin√©es
                </button>
            </div>

            <!-- Filter by category -->
            <div class="flex flex-wrap gap-2 mb-5">
                <button onclick="filterTasks('all')" class="filter-btn active px-3 py-1.5 rounded-lg text-xs font-medium bg-red-600 text-white" data-filter="all">
                    Toutes
                </button>
                {% for cat in categories %}
                <button onclick="filterTasks('{{ cat.id }}')" class="filter-btn px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors" data-filter="{{ cat.id }}">
                    {{ cat.icone }} {{ cat.nom }}
                </button>
                {% endfor %}
            </div>

            <!-- Tasks Grid -->
            <div id="tasks-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                <!-- Filled by JS -->
            </div>

            <div id="no-tasks" class="text-center py-10 text-gray-500 hidden">
                <span class="text-4xl mb-3 block">üìù</span>
                <p class="text-base">Aucune t√¢che pour le moment</p>
                <p class="text-sm mb-4">Cliquez sur "Nouvelle t√¢che" pour commencer</p>
                <button onclick="openTaskModal()" class="bg-red-600 hover:bg-red-700 text-white px-5 py-2 rounded-lg font-medium transition-colors text-sm">
                    + Ajouter une t√¢che
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Task Modal -->
<div id="task-modal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md fade-in max-h-[90vh] overflow-y-auto">
        <div class="p-5 border-b border-gray-100 sticky top-0 bg-white rounded-t-xl">
            <h3 id="task-modal-title" class="text-lg font-semibold text-gray-800">Nouvelle t√¢che</h3>
        </div>
        <form id="task-form" class="p-5 space-y-4">
            <input type="hidden" id="task-id">

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nom de la t√¢che *</label>
                <input type="text" id="task-nom" required class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm" placeholder="Ex: Traiteur, DJ, Fleuriste...">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Cat√©gorie *</label>
                <select id="task-categorie" required class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm">
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.icone }} {{ cat.nom }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Prix estimatif (Ar)</label>
                    <input type="number" id="task-prix-estimatif" min="0" step="1000" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm" placeholder="0">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Prix r√©el (Ar)</label>
                    <input type="number" id="task-prix-reel" min="0" step="1000" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm" placeholder="0">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Assign√© √† *</label>
                <select id="task-assigne" required class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm">
                    <option value="{{ config.nom_partenaire_1 }}">{{ config.nom_partenaire_1 }}</option>
                    <option value="{{ config.nom_partenaire_2 }}">{{ config.nom_partenaire_2 }}</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Commentaires</label>
                <textarea id="task-commentaires" rows="2" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm" placeholder="Notes, d√©tails..."></textarea>
            </div>

            <div class="flex items-center gap-2">
                <input type="checkbox" id="task-statut" class="w-4 h-4 text-red-600 rounded focus:ring-red-500 border-gray-300">
                <label for="task-statut" class="text-sm text-gray-700">T√¢che termin√©e</label>
            </div>
        </form>
        <div class="p-5 border-t border-gray-100 flex justify-end gap-2 sticky bottom-0 bg-white rounded-b-xl">
            <button onclick="closeTaskModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium text-sm">
                Annuler
            </button>
            <button onclick="saveTask()" class="bg-red-600 hover:bg-red-700 text-white px-5 py-2 rounded-lg font-medium transition-colors text-sm">
                Enregistrer
            </button>
        </div>
    </div>
</div>

<!-- Config Modal -->
<div id="config-modal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md fade-in">
        <div class="p-5 border-b border-gray-100">
            <h3 class="text-lg font-semibold text-gray-800">‚öôÔ∏è Configuration</h3>
        </div>
        <form id="config-form" class="p-5 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Date du mariage</label>
                <input type="date" id="config-date" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Budget total (Ar)</label>
                <input type="number" id="config-budget" min="0" step="100000" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm" placeholder="15000000">
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Partenaire 1</label>
                    <input type="text" id="config-partenaire1" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Partenaire 2</label>
                    <input type="text" id="config-partenaire2" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm">
                </div>
            </div>
        </form>
        <div class="p-5 border-t border-gray-100">
            <!-- Reset Section -->
            <div class="mb-4 p-3 bg-red-50 rounded-lg border border-red-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-red-800">R√©initialiser les donn√©es</p>
                        <p class="text-xs text-red-600">Supprimer toutes les t√¢ches</p>
                    </div>
                    <button onclick="openResetModal()" type="button" class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white text-xs font-medium rounded-lg transition-colors">
                        üóëÔ∏è R√©initialiser
                    </button>
                </div>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeConfigModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium text-sm">
                    Annuler
                </button>
                <button onclick="saveConfig()" class="bg-red-600 hover:bg-red-700 text-white px-5 py-2 rounded-lg font-medium transition-colors text-sm">
                    Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reset Confirmation Modal -->
<div id="reset-modal" class="fixed inset-0 bg-black/40 z-[60] hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-sm fade-in">
        <div class="p-6 text-center">
            <span class="text-4xl mb-3 block">‚ö†Ô∏è</span>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">R√©initialiser toutes les donn√©es ?</h3>
            <p class="text-gray-500 text-sm">Toutes les t√¢ches seront supprim√©es d√©finitivement. Cette action est irr√©versible.</p>
        </div>
        <div class="p-5 border-t border-gray-100 flex justify-center gap-2">
            <button onclick="closeResetModal()" class="px-5 py-2 text-gray-600 hover:text-gray-800 font-medium text-sm">
                Annuler
            </button>
            <button onclick="confirmReset()" class="bg-red-600 hover:bg-red-700 text-white px-5 py-2 rounded-lg font-medium transition-colors text-sm">
                Tout supprimer
            </button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-sm fade-in">
        <div class="p-6 text-center">
            <span class="text-4xl mb-3 block">üóëÔ∏è</span>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Supprimer cette t√¢che ?</h3>
            <p class="text-gray-500 text-sm">Cette action est irr√©versible.</p>
        </div>
        <div class="p-5 border-t border-gray-100 flex justify-center gap-2">
            <button onclick="closeDeleteModal()" class="px-5 py-2 text-gray-600 hover:text-gray-800 font-medium text-sm">
                Annuler
            </button>
            <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white px-5 py-2 rounded-lg font-medium transition-colors text-sm">
                Supprimer
            </button>
        </div>
    </div>
</div>

<script>
    // Pass categories data to JS
    const CATEGORIES = {{ categories | tojson | safe }};
    const PARTENAIRE_1 = "{{ config.nom_partenaire_1 }}";
    const PARTENAIRE_2 = "{{ config.nom_partenaire_2 }}";
</script>
{% endblock %}
